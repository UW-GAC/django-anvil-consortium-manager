{% extends "anvil_consortium_manager/__object_detail.html" %}
{% load static %}

{% load render_table from django_tables2 %}

{% block title %}{{ workspace_type_display_name }}: {{ object }}{% endblock %}

{% block pills %}

  {% if object.app_access != object.AppAccessChoices.OWNER %}
    <div class="alert alert-secondary my-3" role="alert">
      <div class="container align-items-center d-flex">
        <div class="">
          <span class="fa-solid fa-ban me-1"></span>
        </div>
        <div class="p-2 flex-grow-1">
            Information on this page may no longer be accurate because the app
            {% if object.app_access == object.AppAccessChoices.LIMITED %}
              has limited access
            {% else %}
              no longer has access
            {% endif %}
             to this workspace:
            <strong>{{ object.app_access_reason }}</strong>
        </div>
      </div>
    </div>
  {% else %}
    {% if has_authorization_domain_not_managed_by_app %}
    <div class="alert alert-warning my-3" role="alert">
      This workspace has at least one authorization domain that is not managed by the app, so access cannot always be determined.
    </div>
    {% endif %}

    {% include 'anvil_consortium_manager/snippets/workspace_is_locked_pill.html' %}

    {% include 'anvil_consortium_manager/snippets/workspace_access_pill.html' %}

    {% include 'anvil_consortium_manager/snippets/workspace_requester_pays_pill.html' %}

    {% block extra_pills %}
    {% endblock extra_pills %}

    {% include 'anvil_consortium_manager/snippets/workspace_view_on_anvil_pill.html' %}
  {% endif %}


{% endblock pills %}

{% block panel %}
<dl class="row">
  <dt class="col-sm-2">Billing project</dt> <dd class="col-sm-10">
    {% if perms.anvil_consortium_manager.anvil_consortium_manager_staff_view %}
      <a href="{{ object.billing_project.get_absolute_url }}">
    {% endif %}
      {{ object.billing_project }}
    {% if perms.anvil_consortium_manager.anvil_consortium_manager_staff_view %}
    </a>
    {% endif %}
  </dd>
  <dt class="col-sm-2">Name</dt> <dd class="col-sm-10">{{ object.name }}</dd>

  {% if perms.anvil_consortium_manager.anvil_consortium_manager_staff_view %}
  <dt class="col-sm-2">Date added</dt> <dd class="col-sm-10">{{ object.created }}</dd>
  <dt class="col-sm-2">Date modified</dt> <dd class="col-sm-10">{{ object.modified }}</dd>
  {% endif %}
</dl>
  {% block workspace_data %}
  {% endblock workspace_data %}
{% endblock panel %}

{% block after_panel %}
  <div>
    <div class="card my-3">
      <div class="card-header">
        <span class="fa-solid fa-shield mx-2"></span>
        Authorization domains
      </div>
      <div class="card-body">
        <p>
          This table shows all Managed Groups that are used as an authorization domain for this Workspace.
        </p>
      {% render_table authorization_domain_table %}
      </div>
    </div>
  </div>

  {% if perms.anvil_consortium_manager.anvil_consortium_manager_staff_view %}
  <div class="my-3">
    <div class="accordion" id="accordionGroups">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingGroupsOne">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGroupsOne" aria-expanded="false" aria-controls="collapseGroupsOne">
            <span class="fa-solid fa-user-group mx-2"></span>
            View groups that this workspace is shared with
            <span class="badge mx-2 bg-secondary pill"> {{ group_sharing_table.rows|length }}</span>
          </button>
        </h2>
        <div id="collapseGroupsOne" class="accordion-collapse collapse" aria-labelledby="headingGroupsOne" data-bs-parent="#accordionGroups">
          <div class="accordion-body">
            <p>
              This table shows Managed Groups that this Workspace has been shared with.
            </p>
            {% render_table group_sharing_table %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endblock after_panel %}



{% block action_buttons %}

<div class="p-1">

  {% if perms.anvil_consortium_manager.anvil_consortium_manager_staff_view and object.app_access == object.AppAccessChoices.OWNER %}
  <a href="{% url 'anvil_consortium_manager:auditor:workspaces:sharing:by_workspace:review' billing_project_slug=object.billing_project.name workspace_slug=object.name %}" class="btn btn-secondary" role="button">Audit sharing</a>
  {% endif %}

</div>

{% if show_edit_links %}
<div class="p-1">

  {% if object.app_access == object.AppAccessChoices.OWNER %}
  <a href="{% url 'anvil_consortium_manager:workspaces:sharing:new' billing_project_slug=object.billing_project.name workspace_slug=object.name %}" class="btn btn-primary" role="button">Share with a group</a>

  <div class="btn-group">
    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
      Update workspace
    </button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="{% url 'anvil_consortium_manager:workspaces:update:internal' billing_project_slug=object.billing_project.name workspace_slug=object.name %}" class="btn btn-secondary" role="button">Internal ACM info</a></li>
      <li><a class="dropdown-item" href="{% url 'anvil_consortium_manager:workspaces:update:requester_pays' billing_project_slug=object.billing_project.name workspace_slug=object.name %}" class="btn btn-secondary" role="button">Change requester pays status</a></li>
    </ul>
  </div>
  {% else %}
    <a href="{% url 'anvil_consortium_manager:workspaces:update:internal' billing_project_slug=object.billing_project.name workspace_slug=object.name %}" class="btn btn-secondary" role="button">Update</a>
  {% endif %}

  {% if object.app_access != object.AppAccessChoices.NO_ACCESS %}
    <div class="btn-group">
      <button type="button" class="btn btn-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
        Clone workspace
      </button>
      <ul class="dropdown-menu">
        {% for workspace_adapter in registered_workspace_adapters %}
        <li><a class="dropdown-item" href="{% url 'anvil_consortium_manager:workspaces:clone' billing_project_slug=object.billing_project.name workspace_slug=object.name workspace_type=workspace_adapter.get_type %}">{{ workspace_adapter.get_name }}</a></li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
</div>

{% if object.app_access == object.AppAccessChoices.OWNER and not object.is_locked %}
<div class="p-1">
  <a href="{% url 'anvil_consortium_manager:workspaces:delete' billing_project_slug=object.billing_project.name workspace_slug=object.name %}" class="btn btn-danger" role="button">Delete on AnVIL</a>
</div>
{% endif %}

{% endif %}

{% endblock action_buttons %}


{% block inline_javascript %}
<script>
  $(document).ready(function(){
      $('[data-bs-toggle="tooltip"]').tooltip();
  });
</script>
{% endblock inline_javascript %}
